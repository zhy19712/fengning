{include file="public/common_header"}
<style>
    .mybtn {
        position: absolute;
        right: 1%;
        top: 0;
    }
    #tableItem_filter{
        float: left;
    }
    #tableItem_length{

    }
    .ztree-title i.fa{
        width: 12%;
    }
    i.fa:before{
        background:none;
    }
    .select-color{
        background-color: #FDD5B5!important;
    }
    h3{
        margin-top: 5px;
        font-weight: 600;
        font-size: 16px;
        display: inline-block;
    }
    .ibox-tools{
        float: right;
        margin-right:30px;
        margin-top: 10px;
    }
    .ibox-tools2{
        float: right;
        margin-right:15px;
    }
    p {
        float: left;
        margin: 4px;
        background-color: #56ABE4;
        text-align: center;
        color: white;
        font-size: 12px;
        border: 1px solid #56ABE4;
        border-radius: 20px;
        float: left;
        line-height: 0.1;
        padding: 5px;
    }
    p i.fa:before {
        color: #fff;
    }
    /*#tableItem_length{*/
        /*position: fixed;*/
        /*float: left;*/
        /*bottom: 0%;*/
    /*}*/
    /*#tableItem_paginate{*/
        /*position: fixed;*/
        /*float: left;*/
        /*margin-left: 20px;*/
        /*bottom: 0%;*/
    /*}*/

</style>
<div data-options="region:'west',title:'角色分类树',split:true" style="width:180px;">
    <div class="ztree-title">
        <i title="新增节点" class="fa fa-lg fa-sitemap" onclick="addNodetree()"></i>
        <i title="编辑节点" class="fa fa-lg fa-pencil" onclick="editNodetree()"></i>
        <i title="删除节点" class="fa fa-lg fa-trash" onclick="delNodetree()"></i>
        <i title="下移" class="fa fa-lg fa-arrow-circle-down" id="downMoveNode"></i>
        <i title="上移" class="fa fa-lg fa-arrow-circle-up" id="upMoveNode"></i>
        <i title="展开所有" class="fa fa-lg fa-plus-square" id="openNode"></i>
        <i title="收起所有" class="fa fa-lg fa-minus-square" id="closeNode"></i>
    </div>
    <ul class="ztree" id="ztree" style="overflow-y: scroll; height: 500px;"></ul>
</div>
<div style="display: none;" id="current_name">{$current_name}</div>
<div data-options="region:'center',title:'当前路径：'" style="padding:5px;background:#eee;">

    <table id="tableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
        <thead>
        <tr>
            <th>编号</th>
            <th>角色名称</th>
            <th>创建人</th>
            <th>创建时间</th>
            <th>角色描述</th>
            <th>操作</th>
        </tr>
        </thead>
    </table>
    <div class="tbcontainer"></div>
    <!--<form  id="roleform" action="#" onsubmit="return false" class="layui-form" style="padding-top: 20px;">-->
        <!--<input type="hidden" name="id" id="addId" style="display: none;">-->
        <!--<div class="layui-form-item">-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">编号</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="number_id" id="number_id" lay-verify="required" placeholder="编号" autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">角色名称</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="role_name" id="role_name" lay-verify="required" lay-verify="required" placeholder="角色名称" autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <!--<hr class="layui-bg-gray">-->
        <!--<div class="layui-form-item">-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">创建人</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="create_owner" id="create_owner" placeholder="创建人" readonly autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">创建时间</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="create_time" id="create_time" placeholder="创建时间" readonly autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <!--<hr class="layui-bg-gray">-->
        <!--<div class="layui-form-item">-->
                <!--<label class="layui-form-label">角色描述</label>-->
                <!--<div class="layui-input-block">-->
                       <!--<textarea name="desc" id="desc"  placeholder="角色描述" placeholder="请输入" class="layui-textarea"></textarea>-->
    <!--</div>-->
        <!--</div>-->
        <!--<hr class="layui-bg-gray">-->
        <!--<div class="layui-form-item">-->
            <!--<div class="col-xs-12" style="text-align: center;">-->
                <!--<button class="layui-btn" lay-submit="" lay-filter="demo1"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;-->
                <!--<button type="reset" class="layui-btn layui-btn-danger"><i class="fa fa-close"></i> 返回</button>-->
            <!--</div>-->
        <!--</div>-->
    <!--</form>-->
</div>
<div data-options="region:'east',title:'管理信息',split:true" style="width:330px;">
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">角色用户</li>
            <li>角色权限</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div style="width: 100%; height: 30px;">
                    <h3 class="path" style="margin-left: 5px;color:#56abe9;"></h3>
                    <div class="ibox-tools">
                        <i title="添加" class="fa fa-lg fa-plus-square" ></i>
                    </div>
                </div>
                <div class="searchName" style="margin-top: 10px;">
                    <input type="text" id="usernameSearch"  class="layui-input" placeholder="用户名称" />
                </div>
                <div class="userContainer" style="width: 100%;"></div>
            </div>
            <div class="layui-tab-item">
                <div>
                    <div style="width: 100%;">
                        <iframe src="/admin/rolemanagement/catepublish.shtml?path=" id="catepublish" frameborder="0" width="100%;" height="690px;"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{include file="public/common_footer"}
<script src="__WEBSITE__/rolemanagement/index.js"></script>
<script src="http://apps.bdimg.com/libs/jquery.cookie/1.4.1/jquery.cookie.min.js"></script>
<script>
    //组织结构表格
    var tableItem = $('#tableItem').DataTable( {
        pagingType: "full_numbers",
        processing: true,
        serverSide: true,
        ajax: {
            "url":"{:url('admin/common/datatablesPre?tableName=admin_cate&id=')}"
        },
        dom: 'lf<"mybtn layui-btn layui-btn-sm">rtip',
        columns:[
            {
                name: "number_id"
            },
            {
                name: "role_name"
            },
            {
                name: "create_owner"
            },
            {
                name: "date"
            },
            {
                name: "desc"
            },
            {
                name: "id"
            }
        ],
        columnDefs: [
            {
                "searchable": false,
                "orderable": false,
                "targets": [5],
                "render" :  function(data,type,row) {
                    var a = data;
                    var html =  "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='conEdit("+data+")'><i class='fa fa-pencil'></i></a>" ;
                    html += "<a type='button' class='' style='margin-left: 5px;' onclick='conDel("+data+")'><i class='fa fa-trash'></i></a>" ;
                    return html;
                }
            },
            {
                "orderable": false,
                "targets": [4]
            }
        ],
        language: {
            "lengthMenu": "_MENU_",
            "zeroRecords": "没有找到记录",
            "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
            "infoEmpty": "无记录",
            "search": "搜索：",
            "infoFiltered": "(从 _MAX_ 条记录过滤)",
            "paginate": {
                "sFirst": "<<",
                "sPrevious": "<",
                "sNext": ">",
                "sLast": ">>"
            }
        },
        "fnInitComplete": function (oSettings, json) {



        }
    });
    //新增
    $(".mybtn").html("新增");

    $("#tableItem_wrapper .mybtn").click(function () {
        if(!selfid){
            layer.msg("请先选择角色分类");
            return;
        }
        var nowtime = new Date().Format("yyyy-MM-dd");
        layer.open({
            type: 1,
            title: '角色管理—新增',
            area: ['690px', '440px'],
            content:dom
        });
        $("#roleform input").val("");
        $("#roleform textarea").val("");
        $("#pid").val(selfid);
        $('#create_owner').val($("#current_name").html());
        $('#create_time').val(nowtime);
    });

    $(function () {
        $("#btnSaveRolePermission").click(function () { saveRolePermission(); });
        initPermissionTree();
    });
    //加载功能菜单树
    function initPermissionTree() {
        var setting = {
            check: {
                enable: true
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            view: {
                selectedMulti: false
            }
        };
        $.ajax({
            type: "Get",
            url: "./",
            success: function (data) {
                $.fn.zTree.init($("#treeRight"), setting, data.result);
            }
        });
    };
    //保存角色与功能关联关系
    function saveRolePermission() {
        var menuIds = [];
        var permissionTree = $.fn.zTree.getZTreeObj("treeRight");
        if (window.parent.selectedRow) {
            var nodes = permissionTree.getCheckedNodes(true);
            $.each(nodes, function (i, item) {
                menuIds.push(item.id);
            });
            var sendData = { "dto": { "RoleId": window.parent.selectedRow.id, "MenuIds": menuIds } }
            $.ajax({
                type: "Post",
                url: "/Role/SaveRoleMenu",
                data: sendData,
                success: function (data) {
                    if (data.result == "Success")
                        layerAlert("保存成功。")
                    else
                        layerAlert("保存失败。")
                }
            });
        }
        else {
            layerAlert("请选择角色。")
        }
    };
    //根据角色关联的功能菜单数据更改选中状态。
    function initMenuDataByRole(roleId) {
        var permissionTree = $.fn.zTree.getZTreeObj("treeRight");
        permissionTree.checkAllNodes(false);
        $.ajax({
            type: "Get",
            url: "/Role/GetMenusByRole?roleId=" + roleId + "&_t=" + new Date(),
            success: function (data) {
                $.each(data.result.menus, function (i, item) {
                    var node = permissionTree.getNodeByParam("id", item.id, null);
                    if (node)
                        permissionTree.checkNode(node, true, false);
                });
            }
        });
    };
</script>
</body>
</html>