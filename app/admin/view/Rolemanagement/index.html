{include file="public/common_header"}
<style>
    .mybtn {
        position: absolute;
        right: 1%;
        top: 0;
    }
    #tableItem_filter{
        float: left;
    }
    #tableItem_length{

    }
    .layui-icon{
        float: left;
        line-height: 40px;
        text-align: center;
        width: 25%;
    }
    .layui-icon:hover{
        background-color:#1E9FFF;
        color: #fff!important;
    }
</style>
<div data-options="region:'west',title:'角色分类树',split:true" style="width:180px;">
    <div style="height:30px">
        <i class="layui-icon" onclick="addNodetree()" style="font-size: 20px; color: #1E9FFF;">&#xe654;</i>
        <i class="layui-icon" onclick="editNodetree()" style="font-size: 20px; color: #1E9FFF;">&#xe642;</i>
        <i class="layui-icon" onclick="delNodetree()" style="font-size: 20px; color: #1E9FFF;">&#xe640;</i>
        <i class="layui-icon" style="font-size: 20px; color: #1E9FFF;">&#xe61a;</i>
    </div>
    <hr />
    <ul class="ztree" id="ztree"></ul>
</div>
<div data-options="region:'center',title:'当前路径：'" style="padding:5px;background:#eee;">
    <table id="tableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
        <thead>
        <tr>
            <th>编号</th>
            <th>角色名称</th>
            <th>创建人</th>
            <th>创建时间</th>
            <th>角色描述</th>
            <th>操作</th>
        </tr>
        </thead>
    </table>
    <!--<form  id="roleform" action="#" onsubmit="return false" class="layui-form">-->
        <!--<div class="layui-form-item">-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">编号</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="number_id" id="date1" lay-verify="date" placeholder="编号" autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">角色名称</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="role_name" id="role_name" lay-verify="date" lay-verify="required" placeholder="角色名称" autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <!--<div class="layui-form-item">-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">创建人</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="create_owner" placeholder="创建人" autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="layui-inline">-->
                <!--<label class="layui-form-label">创建时间</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="create_time" placeholder="创建时间" autocomplete="off" class="layui-input">-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <!--<div class="layui-form-item">-->
                <!--<label class="layui-form-label">角色描述</label>-->
                <!--<div class="layui-input-block">-->
                    <!--<input type="area" name="desc" placeholder="角色描述"  autocomplete="off" class="layui-input">-->
                <!--</div>-->
        <!--</div>-->

        <!--<div class="layui-form-item">-->
            <!--<div class="col-xs-12" style="text-align: center;">-->
                <!--<button class="layui-btn" lay-submit="" lay-filter="demo1"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;-->
                <!--<button type="reset" class="layui-btn layui-btn-danger"><i class="fa fa-close"></i> 返回</button>-->
                <!--&lt;!&ndash;<a class="layui-btn layui-btn-danger layui-layer-close layui-layer-close1" href="javascript:;"><i class="fa fa-close"></i>返回</a>&ndash;&gt;-->
            <!--</div>-->
        <!--</div>-->
    <!--</form>-->
</div>
<div data-options="region:'east',title:'管理信息',split:true" style="width:280px;">
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">角色用户</li>
            <li>角色权限</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                1. 高度默认自适应，也可以随意固宽。
                <br>2. Tab进行了响应式处理，所以无需担心数量多少。
            </div>
            <div class="layui-tab-item">内容2</div>
        </div>
    </div>
</div>

{include file="public/common_footer"}
<script>
    var selfid,zTreeObj,groupid,sNodes;
    //字符解码
    function ajaxDataFilter(treeId, parentNode, responseData) {

        if (responseData) {
            for(var i =0; i < responseData.length; i++) {
                responseData[i] = JSON.parse(responseData[i]);
                responseData[i].name = decodeURIComponent(responseData[i].name);
            }
        }
        return responseData;
    }
    //组织结构树
    var setting = {
        view: {
            showLine: true, //设置 zTree 是否显示节点之间的连线。
            selectedMulti: false, //设置是否允许同时选中多个节点。
            // dblClickExpand: true //双击节点时，是否自动展开父节点的标识。
        },
        async: {
            enable : true,
            autoParam: ["pid"],
            type : "post",
            url : "./roletree",
            dataType :"json",
            dataFilter: ajaxDataFilter
        },
        data:{
            keep: {
                leaf : true,
                parent : true
            },
            simpleData : {
                enable:true,
                idkey: "id",
                pIdKey: "pid",
                rootPId:0
            }
        },
        callback: {
            onClick: this.onClick
        }
    };

    zTreeObj = $.fn.zTree.init($("#ztree"), setting, null);

    //组织结构表格
    var tableItem = $('#tableItem').DataTable( {
        pagingType: "full_numbers",
        processing: true,
        serverSide: true,
        ajax: {
            "url":"{:url('admin/common/datatablesPre?tableName=admin_cate&id=')}"
        },
        dom: 'lf<"mybtn layui-btn layui-btn-sm">rtip',
        columns:[
            {
                name: "number_id"
            },
            {
                name: "role_name"
            },
            {
                name: "create_owner"
            },
            {
                name: "create_time"
            },
            {
                name: "desc"
            },
            {
                name: "desc"
            }
        ],
        columnDefs: [
            {
                "searchable": false,
                "orderable": false,
                "targets": [5],
                "render" :  function(data,type,row) {
                    var html = "<i class=\"layui-icon\"></i>" ;
                    html += "<i class=\"layui-icon\"></i>" ;
                    return html;
                }
            }
        ],
        language: {
            "lengthMenu": "_MENU_",
            "zeroRecords": "没有找到记录",
            "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
            "infoEmpty": "无记录",
            "search": "搜索：",
            "infoFiltered": "(从 _MAX_ 条记录过滤)",
            "paginate": {
                "previous": "<",
                "next": ">"
            }
        }
    });

    $(".mybtn").html("新增");
    //新增
    var dom = ['<form  id="roleform" action="#" onsubmit="return false" class="layui-form">',
        '        <div class="layui-form-item">',
        '            <div class="layui-inline">',
        '                <label class="layui-form-label">编号</label>',
        '                <div class="layui-input-inline">',
        '                    <input type="text" name="number_id" id="date1" lay-verify="date" placeholder="编号" autocomplete="off" class="layui-input">',
        '                </div>',
        '            </div>',
        '            <div class="layui-inline">',
        '                <label class="layui-form-label">角色名称</label>',
        '                <div class="layui-input-inline">',
        '                    <input type="text" name="role_name" id="role_name" lay-verify="date" lay-verify="required" placeholder="角色名称" autocomplete="off" class="layui-input">',
        '                </div>',
        '            </div>',
        '        </div>',
        '        <div class="layui-form-item">',
        '            <div class="layui-inline">',
        '                <label class="layui-form-label">创建人</label>',
        '                <div class="layui-input-inline">',
        '                    <input type="text" name="create_owner" placeholder="创建人" autocomplete="off" class="layui-input">',
        '                </div>',
        '            </div>',
        '            <div class="layui-inline">',
        '                <label class="layui-form-label">创建时间</label>',
        '                <div class="layui-input-inline">',
        '                    <input type="text" name="create_time" placeholder="创建时间" autocomplete="off" class="layui-input">',
        '                </div>',
        '            </div>',
        '        </div>',
        '        <div class="layui-form-item">',
        '                <label class="layui-form-label">角色描述</label>',
        '                <div class="layui-input-block">',
        '                    <input type="area" name="desc" placeholder="角色描述"  autocomplete="off" class="layui-input">',
        '                </div>',
        '        </div>',
        '        <div class="layui-form-item">',
        '            <div class="col-xs-12" style="text-align: center;">',
        '                <button class="layui-btn" lay-submit="" lay-filter="demo1"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;',
        '                <button type="reset" class="layui-btn layui-btn-danger"><i class="fa fa-close"></i> 返回</button>',
        '                <!--<a class="layui-btn layui-btn-danger layui-layer-close layui-layer-close1" href="javascript:;"><i class="fa fa-close"></i>返回</a>-->',
        '            </div>',
        '        </div>',
        '    </form>'].join("");
    $("#tableItem_wrapper .mybtn").click(function () {
        layer.open({
            type: 1,
            title: '角色管理—新增',
            area: ['390px', '260px'],
            content:dom
        });
    });

    //tab 切换
    layui.use(['element',"layer"], function(){
        var $ = layui.jquery
            ,element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
    });

    //点击获取路径
    function onClick(e, treeId, node) {
        $(".layout-panel-center .panel-title").text("");
        sNodes = zTreeObj.getSelectedNodes();//选中节点
        selfid = zTreeObj.getSelectedNodes()[0].id
        var path = sNodes[0].name; //选中节点的名字
        node = sNodes[0].getParentNode();//获取父节点
        //判断是否还有父节点
        if (node) {
            //判断是否还有父节点
            while (node){
                path = node.name + ">>" + path;
                node = node.getParentNode();
            }
        }else{
            $(".layout-panel-center .panel-title").text(sNodes[0].name);
        }
        //判断是否拉数据
        groupid = sNodes[0].pId //父节点的id
        if (!sNodes[0].children){
            var url = "/admin/common/datatablespre/tableName/admin_cate/id/"+selfid+".shtml";
            tableItem.ajax.url(url).load();
        }
        $(".layout-panel-center .panel-title").text("当前路径:"+path)
    }
    //点击添加 删除 编辑节点
    function addNodetree() {
            $.ajax({
                url:'./editCatetype',
                type:"post",
                data:{id:selfid,pid:groupid,name:sNodes[0].name},
                success: function (res) {
                    if(res.code===1){
                        layer.msg("删除节点成功",{time:1500,shade: 0.1});
                        zTreeObj.reAsyncChildNodes(null, "refresh");
                    }
                }
            });
    };

    function editNodetree() {
        if(!selfid){
            layer.msg("请选择节点",{time:1500,shade: 0.1});
            return;
        }
        // $.ajax({
        //     url: "getOneNode",
        //     type: "post",
        //     data: {id:selfid},
        //     dataType: "json",
        //     success: function (res) {
        //         if(sNodes.level == 0) {
        //             $("#level2 input").val("");
        //             $("#treePid").val(mytree_node.pId);
        //             $("#id2").val(mytree_node.id);
        //             $("#companyName").val(res.pname);
        //             $("#level2 h5").text('编辑');
        //             $("#level2").modal('show');
        //         }else if(sNodes.level == 1) {
        //             $("#level2 input").val("");
        //             $("#treePid").val(mytree_node.pId);
        //             $("#id2").val(mytree_node.id);
        //             $("#companyName").val(res.pname);
        //             $("#level2 h5").text('编辑');
        //             $("#level2").modal('show');
        //         }
        //     }
        // })
    };
    function delNodetree() {
        if(!selfid){
            layer.msg("请选择节点");
            return;
        }
        if(!sNodes[0].children){
            layer.confirm("该操作会将关联数据同步删除，是否确认删除？",function () {
                $.ajax({
                    url:'./delCatetype',
                    type:"post",
                    data:{id:selfid},
                    success: function (res) {
                        if(res.code===1){
                            layer.msg("删除节点成功",{time:1500,shade: 0.1});
                            zTreeObj.reAsyncChildNodes(null, "refresh");
                        }
                    }
                });
            });
        }else{
            layer.msg("包含下级，无法删除",{time:1500,shade: 0.1});
        }

    };
</script>
</body>
</html>