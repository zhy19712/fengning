<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>fengning_main</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="__PUBLIC__/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="__PUBLIC__/layui/css/modules/layer/default/layer.css" media="all">
    <link rel="stylesheet" href="__PUBLIC__/font-awesome/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="__PUBLIC__/jquery/jquery.min.js"></script>
    <script type="text/javascript" charset="utf8" src="__PUBLIC__/layui/lay/modules/layer.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.js"></script>
    <style type="text/css">
        #path{
            line-height: 30px;
            font-weight: 700;
            border-bottom: 1px solid #000;
        }
        #spanPath{
            display: inline-block;
            float: left;
        }
        #mytable1_wrapper{
            position: relative;
            margin-top: 5px;
        }
        .mybtn{
            position: absolute;
            right: 1%;
            top: 0;
        }
        .float_left{
            float: left;
        }
        .dataTables_length{
            height: 8px;
            position:absolute;
            bottom: 18px;
            left: 175px;
        }
    </style>
<body class="layui-layout-body" style="overflow-y:visible;">
    <!--表格-->
    <div class="wrapper wrapper-content animated fadeInRight" style="width: 98%;vertical-align: top;padding: 0;margin-top: 20px;margin-left: 20px;text-align: center">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <div class="row">
                    <div id="path"><span id="spanPath">合同登记</span><div style="clear: both;"></div></div>
                    <div id="mytable1_wrapper">
                        <table id="admin_table" width="100%" class="table table-striped table-bordered">
                            <thead>
                            <tr>
                                <td style="display: none;"></td>
                                <td>合同编号</td>
                                <td>合同名称</td>
                                <td>乙方</td>
                                <td>乙方简称</td>
                                <td>合同总金额（万元）</td>
                                <td>签订日期</td>
                                <td>操作</td>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
<script>



     var admin_table = $('#admin_table').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url:"{:url('contract/common/datatablesPre?tableName=contract')}"
            },
            dom: '<"mybtn layui-btn layui-btn-sm"><"selectyear"><"myl"l><"float_left"f>tip',
            columns:[
                {
                    name: "id"
                },
                {
                    name: "contractCode"
                },
                {
                    name: "contractName"
                },
                {
                    name: "secondParty"
                },
                {
                    name: "secondPartShortName"
                },
                {
                    name: "contractAmount"
                },
                {
                    name: "signingDate"
                }
            ],
            columnDefs: [
                {
                    searchable: false,
                    orderable: false,
                    targets: [6],
                    render :  function(data,type,row) {
                        var html =  "<input type='button' class='layui-btn layui-btn-xs btn-xs' style='margin-left: 5px;' onclick='conEdit(this)' value='编辑'/>" ;
                        html += "<input type='button' class='btn btn-danger  btn-xs' style='margin-left: 5px;' onclick='conDel(this)' value='删除'/>" ;
                        return html;
                    }
                },
            ],
            language: {
                "lengthMenu": "每页_MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "search": "搜索：",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "paginate": {
                    "previous": "上一页",
                    "next": "下一页"
                }
            }
        });
        $("div.mybtn").html('<div id="xz">新增</div>');
        // $("#contract_modal").html('<div id="xz">新增</div>');

        //新增
        $("#admin_table_wrapper .mybtn").click(function () {
            layer.open({
                type: 2,
                title: '新增合同',
                shadeClose: true,
                area: ['780px', '550px'],
                content: '{:url("add")}',
                success: function(layero, index){
                    var laysrc = layer.getChildFrame('#nameLay', index);
                    var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                    // console.log(body.html()) //得到iframe页的body内容
                    console.log(laysrc.html())


                },
                end:function () {
                    admin_table.ajax.url("{:url('contract/common/datatablesPre?tableName=contract')}").load();
                }
            });
        })

    //编辑
    function conEdit(that){
        var id = $(that).parent("td").parent("tr").children("td:first-child").text();
        console.log(id)
        var contractCode ,
            contractName,
            firstParty,
            secondParty,
            contractAmount,
            secondPartyCorporation,
            firstPartyCorporation,
            createUser,
            signingDate,
            secondProjectManager,
            firstLinkMan,
            contractDay,
            startDate,
            endDate,
            contractLive,
            projectName,
            secondPartShortName,id
        ;

        $.ajax({
            url: "{:url('./contract/contract/getOne')}?id="+id,
            type: "post",
            data: {id:id},
            dataType: "json",
            success: function (res) {
                console.log(res);
                id  = res.id;
                contractCode = res.contractName;
                contractName = res.contractName;
                firstParty = res.firstParty;
                secondParty = res.secondParty;
                contractAmount = res.contractAmount;
                secondPartyCorporation = res.secondPartyCorporation;
                firstPartyCorporation = res.firstPartyCorporation;
                createUser = res.createUser;
                signingDate = res.signingDate;
                secondProjectManager = res.secondProjectManager;
                firstLinkMan = res.firstLinkMan;
                contractDay = res.contractDay;
                startDate = res.startDate;
                endDate = res.endDate;
                contractLive = res.contractLive;
                projectName = res.projectName;
                secondPartShortName = res.secondPartShortName;
            }
        })
        layer.open({
            type: 2,
            title: '编辑合同',
            shadeClose: true,
            area: ['780px', '550px'],
            content: '{:url("add")}',
            success: function(layero, index){
                var body = layer.getChildFrame('body', index);
                var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                console.log(body.html()) //得到iframe页的body内容
                body.find('input[name="id"]').val(id);
                body.find('input[name="contractCode"]').val(contractCode);
                body.find('input[name="contractName"]').val(contractName);
                body.find('input[name="firstParty"]').val(firstParty);
                body.find('input[name="secondParty"]').val(secondParty);
                body.find('input[name="contractAmount"]').val(contractAmount);
                body.find('input[name="secondPartyCorporation"]').val(secondPartyCorporation);
                body.find('input[name="firstPartyCorporation"]').val(firstPartyCorporation);
                body.find('input[name="createUser"]').val(createUser);
                body.find('input[name="signingDate"]').val(signingDate);
                body.find('input[name="secondProjectManager"]').val(secondProjectManager);
                body.find('input[name="firstLinkMan"]').val(firstLinkMan);
                body.find('input[name="contractDay"]').val(contractDay);
                body.find('input[name="startDate"]').val(startDate);
                body.find('input[name="endDate"]').val(endDate);
                body.find('input[name="contractLive"]').val(contractLive);
                body.find('input[name="projectName"]').val(projectName);
                body.find('input[name="secondPartShortName"]').val(secondPartShortName);

            }
        });
    }
    //删除
    function conDel(that){
        layer.confirm('是否删除该合同?', function(index){
            var id = $(that).parent("td").parent("tr").children("td:first-child").text();
            console.log(id)
            $.ajax({
                url: "{:url('./contract/contract/del')}",
                type: "post",
                data: {id:id},
                dataType: "json",
                success: function (res) {
                    console.log(res);
                    if(res.code == 1){
                        layer.msg("删除成功！");
                        admin_table.ajax.url("{:url('contract/common/datatablesPre?tableName=contract')}").load();
                    }
                }
            });
            layer.close(index);
        });
    }
</script>
</html>