{include file="../../admin/view/public/common_header"}
<style>

    #nodeZtree .ztree-title i.fa {
        width: 12%;
    }
    #nodeZtree .ztree-title #add {
        margin-left: 6px;
    }

    #tableContent .mybtn i.fa:before {
        background: #00c0ef;
        color: #ffffff;
    }

    #tableContent .mybtn {
        position: absolute;
        right: 1%;
        top: 0;
        background-color: #00c0ef;
    }

    #tableContent #tableItem_filter {
        float: left;
    }

    #tableContent .select-color {
        background-color: #FDD5B5 !important;
    }

    #tableContent h3 {
        margin-top: 5px;
        font-weight: 600;
        font-size: 16px;
        display: inline-block;
    }

    #tableContent .ibox-tools {
        float: right;
        margin-right: 30px;
        margin-top: 10px;
    }

    #tableContent .ibox-tools2 {
        float: right;
        margin-right: 15px;
    }

    #tableContent .dataTables_wrapper .dataTables_scroll {
        position: relative;
        top: 15px;
        border-top: 1px dotted #cecece;
    }

    #information .layui-tab-content .tt{
        width: 100%;
        border: 1px solid red;
    }
    #information .layui-tab-content #tableAttr tr td{
        padding: 8px;
        border-top: 1px solid #e7eaec;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
        font-size: 12px;
        max-height: 40px;
    }
    #information .layui-tab-content #tableAttr tr:hover{
        background: #FDD5B5;
    }

</style>

<div id="nodeZtree" data-options="region:'west',title:'文档目录树',split:true" style="width:180px;">
    <div class="ztree-title">
        <i id="add" title="新增节点" class="fa fa-lg fa-sitemap" onclick="addNodetree()"></i>
        <i title="编辑节点" class="fa fa-lg fa-pencil" onclick="editNodetree()"></i>
        <i title="删除节点" class="fa fa-lg fa-trash" onclick="delNodetree()"></i>
        <!--<i title="下移" class="fa fa-lg fa-arrow-circle-down" id="downMoveNode"></i>-->
        <!--<i title="上移" class="fa fa-lg fa-arrow-circle-up" id="upMoveNode"></i>-->
        <i title="展开所有" class="fa fa-lg fa-plus-square" id="openNode"></i>
        <i title="收起所有" class="fa fa-lg fa-minus-square" id="closeNode"></i>
    </div>
    <ul class="ztree" id="ztree"></ul>
</div>
<div id="tableContent" data-options="region:'center',title:'当前路径：'" style="padding:5px;background:#ffffff;">
    <table id="tableItem" class="table table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
        <tr>
            <th>文件名称</th>
            <th>上传人</th>
            <th>上传时间</th>
            <th>当前审批人</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
        </thead>
    </table>
    <div class="info"></div>
    <div class="tbcontainer">
        <div class="mark"></div>
    </div>
</div>
<div id="information" data-options="region:'east',title:'管理信息',split:true" style="width:330px;">
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">属性</li>
            <li>共享</li>
            <li>关联关系</li>
        </ul>
        <div class="layui-tab-content">
            <!--属性-->
            <div class="layui-tab-item layui-show tt">
                <div>
                    <table id="tableAttr" class="table table-striped table-bordered" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <td>文件名称</td>
                                <td id="fileName"></td>
                            </tr>
                            <tr>
                                <td>文件类别</td>
                                <td id="fileCategory"></td>
                            </tr>
                            <tr>
                                <td>上传人</td>
                                <td id="uploadPerson"></td>
                            </tr>
                            <tr>
                                <td>上传时间</td>
                                <td id="uploadTime"></td>
                            </tr>
                            <tr>
                                <td>文件大小</td>
                                <td id="fileSize"></td>
                            </tr>
                        </thead>
                    </table>
                    <!--<h3 class="path" style="margin-left: 5px;color:#56abe9;"></h3>-->
                    <!--<div class="ibox-tools">-->
                        <!--<i title="添加" class="fa fa-lg fa-plus-square"></i>-->
                    <!--</div>-->
                </div>
                <div class="searchName">
                    <!--<input type="text" id="usernameSearch" class="layui-input" placeholder="用户名称"/>-->
                </div>
                <div class="userContainer"></div>
            </div>
            <!--共享-->
            <div class="layui-tab-item">
                <div>
                    <!--<div style="width: 100%;">-->
                    <!--<iframe src="/admin/rolemanagement/catepublish.shtml?path=" id="catepublish" frameborder="0" width="100%;" height="690px;"></iframe>-->
                    <!--</div>-->
                </div>
            </div>
            <!--关联关系-->
            <div class="layui-tab-item">
                <div>
                    <!--<div style="width: 100%;">-->
                    <!--<iframe src="/admin/rolemanagement/catepublish.shtml?path=" id="catepublish" frameborder="0" width="100%;" height="690px;"></iframe>-->
                    <!--</div>-->
                </div>
            </div>
        </div>
    </div>
</div>

{include file="../../admin/view/public/common_footer"}
<script src="__WEBSITE__/archive/document/index.js"></script>
<script>

    //组织结构表格
    var tableItem = $('#tableItem').DataTable({
        pagingType: "full_numbers",
        processing: true,
        serverSide: true,
        sScrollX: '600px',
        ajax: {
            "url": "{:url('/archive/common/datatablesPre')}?tableName=archive_document&id="
        },
        dom: 'lf<"mybtn layui-btn layui-btn-sm">rtip',
        columns: [
            {
                name: "name"
            },
            {
                name: "nickname"
            },
            {
                name: "create_time"
            },
            {
                name: "id"
            },
            {
                name: "status"
            },
            {
                name: "id"
            }
        ],
        columnDefs: [
            {
                "searchable": false,
                "orderable": false,
                "targets": [5],
                "render": function (data, type, row) {
                    var a = data;
                    var html = "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='conEdit(" + data + ")'><i class='fa fa-trash'></i></a>";
                    html += "<a type='button' class='' style='margin-left: 5px;' onclick='conDel(" + data + ")'><i class='fa fa-pencil'></i></a>";
                    html += "<a type='button' class='' style='margin-left: 5px;' onclick='conDel(" + data + ")'><i class='fa fa-chain'></i></a>";
                    html += "<a type='button' class='' style='margin-left: 5px;' onclick='conDel(" + data + ")'><i class='fa fa-file-text'></i></a>";
                    return html;
                }
            },
            {
                targets: [3],
                //审批人，目前没数据留空
                render: function (data, type, row) {
                    return "";
                }
            },
            {
                targets: [4],
                render: function (data, type, row) {
                    if (data == 1) {
                        return "已归档";
                    }
                    return "待归档";
                }
            }
        ],
        language: {
            "lengthMenu": "_MENU_",
            "zeroRecords": "没有找到记录",
            "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
            "infoEmpty": "无记录",
            "search": "搜索：",
            "infoFiltered": "(从 _MAX_ 条记录过滤)",
            "paginate": {
                "sFirst": "<<",
                "sPrevious": "<",
                "sNext": ">",
                "sLast": ">>"
            }
        },
        "fnInitComplete": function (oSettings, json) {
            $('#tableItem_length').insertBefore(".mark");
            $('#tableItem_info').insertBefore(".mark");
            $('#tableItem_paginate').insertBefore(".mark");
        }
    });

    //点击上传文件
    $(".mybtn").html("<div id='test3'><i class='fa fa-plus'></i>上传文件</div>");

    var upload ;
    var uploadId ;
    var uploadName ;
    // $(".mybtn >div").click(function () {
    //     if (!selfid) {
    //         layer.msg("请选择节点", {time: 1500, shade: 0.1});
    //         return;
    //     }else if(selfid){
    //         $(".mybtn >div").attr("id","test3");
    //         layui.upload.render({
    //             elem: '#test3',
    //             url: "{:url('admin/common/upload?module=document&use=archive')}",
    //             accept: 'file',//普通文件
    //             exts: 'doc|docx|pdf',
    //             before: function(obj){
    //                 obj.preview(function(index, file, result){
    //                     uploadName = file.name;
    //                     console.log(file.name);//获取文件名，result就是base64
    //                 })
    //             },
    //             done: function(res){
    //                 console.log(res)
    //                 if(res.code == 2){
    //                     uploadId = res.id;
    //                     $.ajax({
    //                         url:"{:url('documenttype/add')}",
    //                         data:{
    //                             name: uploadName, //名称
    //                             attachmentId: uploadId,  //文档关联Id
    //                             type:selfid,
    //                         },
    //                         type:'post',
    //                         success:function(res) {
    //                             console.log(res)
    //                             // if(res.code == 1) {
    //                             //     layer.alert(res.msg, function(index){
    //                             //         location.href = res.url;
    //                             //     })
    //                             // } else {
    //                             //     layer.msg(res.msg);
    //                             // }
    //                         }
    //                     })
    //                     layer.msg("上传成功！",{time:1500})
    //                 }else{
    //                     layer.msg("上传失败！",{time:1500})
    //                 }
    //             },
    //         });
    //     }
    // })

    //管理信息的tab 切换
    layui.use(['element', "layer", 'form', 'upload'], function () {
        var $ = layui.jquery
            , element = layui.element //Tab的切换功能，切换事件监听等，需要依赖element模块
            , upload = layui.upload;

        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;

        //监听提交
        form.on('submit(demo1)', function (data) {
            $.ajax({
                type: "post",
                url: "./editCate",
                data: data.field,
                success: function (res) {
                    if (res.code == 1) {
                        var url = "/admin/common/datatablespre/tableName/admin_cate/id/" + selfid + ".shtml";
                        tableItem.ajax.url(url).load();
                        parent.layer.msg('保存成功！');
                        layer.closeAll();
                    }
                },
                error: function (data) {
                    debugger;
                }
            });
            return false;
        });
        upload.render({
            elem: '#test3',
            url: "{:url('admin/common/upload?module=document&use=archive')}",
            accept: 'file',//普通文件
            exts: 'doc|docx|pdf',
            before: function(obj){
                obj.preview(function(index, file, result){
                    uploadName = file.name;
                    console.log(file.name);//获取文件名，result就是base64
                })
            },
            done: function(res){
                console.log(res)
                if(res.code == 2){
                    uploadId = res.id;
                    $.ajax({
                        url:"{:url('document/add')}",
                        data:{
                            name: uploadName, //名称
                            attachmentId: uploadId,  //文档关联Id
                            type:selfid,
                        },
                        type:'post',
                        success:function(res) {
                            console.log(res)
                            if(res.code == 1) {
                                var url = "{:url('/archive/common/datatablesPre')}?tableName=archive_document&id="+selfid;
                                tableItem.ajax.url(url).load();
                            } else {
                                layer.msg('获取数据失败！');
                            }
                        }
                    })
                    layer.msg("上传成功！",{time:1500})
                }else{
                    layer.msg("上传失败！",{time:1500})
                }
            },
        });
    });





    $(function () {
        initPermissionTree();
    });

    //加载功能菜单树
    function initPermissionTree() {
        var setting = {
            check: {
                enable: true
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            view: {
                selectedMulti: false
            }
        };
        $.ajax({
            type: "Get",
            url: "{:url('documenttype/getAll')}",
            success: function (data) {
                $.fn.zTree.init($("#treeRight"), setting, data.result);
            }
        });
    };

    //初始化树节点
    var selfid,
        nodeName,
        nodePid,
        zTreeObj,
        groupid,
        sNodes;
    var setting = {
        view: {
            showLine: true, //设置 zTree 是否显示节点之间的连线。
            selectedMulti: false, //设置是否允许同时选中多个节点。
            // dblClickExpand: true //双击节点时，是否自动展开父节点的标识。
        },
        async: {
            enable: true,
            autoParam: ["pid"],
            type: "post",
            url: "{:url('documenttype/getAll')}",
            dataType: "json",
            // dataFilter: ajaxDataFilter
        },
        data: {
            simpleData: {
                enable: true,
                idkey: "id",
                pIdKey: "pid",
                rootPId: 0
            }
        },
        callback: {
            onClick: this.nodeClick
        }
    };
    zTreeObj = $.fn.zTree.init($("#ztree"), setting, null);



    //点击获取路径
    function nodeClick(e, treeId, node) {
        console.log(node);
        selectData = "";
        sNodes = zTreeObj.getSelectedNodes();//选中节点
        console.log(sNodes);
        selfid = zTreeObj.getSelectedNodes()[0].id;//当前id
        nodeName = zTreeObj.getSelectedNodes()[0].name;//当前name
        nodePid = zTreeObj.getSelectedNodes()[0].pid;//当前pid
        console.log(selfid + '---id');
        console.log(nodeName + '---name');
        console.log(nodePid + '---pid');
        var path = sNodes[0].name; //选中节点的名字
        node = sNodes[0].getParentNode();//获取父节点
        //判断是否还有父节点
        if (node) {
            //判断是否还有父节点
            while (node) {
                path = node.name + "-" + path;
                node = node.getParentNode();
            }
        } else {
            $(".layout-panel-center .panel-title").text(sNodes[0].name);
        }
        groupid = sNodes[0].pId //父节点的id
        // var url = "/admin/common/datatablespre/tableName/admin_cate/id/"+selfid+".shtml";
        // tableItem.ajax.url(url).load();
        $(".layout-panel-center .panel-title").text("当前路径:" + path)
    }

    //点击添加节点
    function addNodetree() {
        var pid = selfid ? selfid : 0;
        layer.prompt({title: '请输入节点名称',}, function (value, index, elem) {
            $.ajax({
                url: "{:url('documenttype/addOrEdit')}",
                type: "post",
                data: {pid: pid, name: value},
                success: function (res) {
                    console.log(res)
                    if (res.code === 1) {
                        console.log(sNodes)
                        if (sNodes) {
                            zTreeObj.addNodes(sNodes[0], {"id":res.data,"pid":pid,"name":value});
                        } else {
                            zTreeObj.addNodes(null, {"id":res.data,"pid":pid,"name":value});
                        }
                    }
                }
            });
            layer.close(index);
        });
    };

    //编辑节点
    function editNodetree() {
        if (!selfid) {
            layer.msg("请选择节点", {time: 1500, shade: 0.1});
            return;
        }
        console.log(sNodes[0])
        layer.prompt({
            title: '编辑',
            value: sNodes[0].name
        }, function (value, index, elem) {
            $.ajax({
                url: "{:url('documenttype/addOrEdit')}",
                type: "post",
                data: {id: selfid, name: value},
                success: function (res) {
                    if (res.code === 1) {
                        sNodes[0].name = value;
                        zTreeObj.updateNode(sNodes[0]);//更新节点名称
                        layer.msg("编辑成功")
                    }
                }
            });
            layer.close(index);
        });
    };

    //删除节点
    function delNodetree() {
        if (!selfid) {
            layer.msg("请选择节点");
            return;
        }
        if (!sNodes[0].children) {
            layer.confirm("该操作会将关联数据同步删除，是否确认删除？", function () {
                $.ajax({
                    url: "{:url('documenttype/del')}",
                    type: "post",
                    data: {id: selfid},
                    success: function (res) {
                        if (res.code === 1) {
                            layer.msg("删除节点成功", {time: 1500, shade: 0.1});
                            //下面是更新列表
                            // var url = "/admin/common/datatablespre/tableName/admin_cate/id/"+selfid+".shtml";
                            // tableItem.ajax.url(url).load();
                            zTreeObj.removeNode(sNodes[0]);
                            selfid = "";
                        }
                    }
                });
            });
        } else {
            layer.msg("包含下级，无法删除", {time: 1500, shade: 0.1});
        }

    };

    //全部展开
    $('#openNode').click(function () {
        zTreeObj.expandAll(true);
    });

    //收起所有
    $('#closeNode').click(function () {
        zTreeObj.expandAll(false);
    });

</script>
</body>
</html>