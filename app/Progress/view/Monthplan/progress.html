{include file="../app/public/common_header.html"}
<style>
    .center{
        border: 0;

    }
    #viewTop{
        margin-top: 10px;
    }

    #fu{
        width:90%;
        height: 15px;
        /*border:1px solid darkcyan;*/
        margin: 20px auto;
        display: block;
        background-color: #e2e2e2;
        position: relative;
        top: 20px;
    }
    #zi{
        width:2px;
        height: 15px;
        background:lightseagreen;
    }

    #bai{
        text-align: center;
        line-height: 15px;
        color: white;
    }
    #ad{
        height: 60px;
        border: 1px solid red;
        position: absolute;
        margin-top: 10px;
        right: 5%;
    }
    #ad i{
        margin: 0 15px;
    }
    .tipStyle{
        width: 96px;
        height: 20px;
        border: 1px solid darkseagreen;
        color: white;
        background: darkseagreen;
        text-align: center;
    }
    #leftTips,#leftTop{
        position: absolute;
        top: -25px;
        left: -48px;
        /*border: 1px solid red;*/
    }
    #rightTips{
        position: absolute;
        top: -25px;
        right: -48px;
    }

    #viewCenter{
        width: 99%;
        height: 88%;
        margin: 0 auto;
        position: relative;
        margin-top: 100px;
    }
</style>

<div data-options="region:'center'" class="center">
        <div id="viewTop">
            <div id="fu">
                <div id="zi">
                    <div id="bai"></div>
                    <div id="leftTips" class="tipStyle">2017-5-1</div>
                </div>

                <div id="leftTop" class="tipStyle">2017-5-1</div>
                <div id="rightTips" class="tipStyle">2017-5-15</div>
            </div>
            <div id="ad" style="margin-bottom: 40px">
                <i title="快退" id="backward" class="fa fa-fast-backward"></i>
                <i title="开始" id="start" class="fa fa-play"></i>
                <i title="暂停" id="suspend" class="fa fa-pause" style="display: none"></i>
                <i title="快进" id="forward" class="fa fa-fast-forward"></i>
                <i title="关闭页面" id="close" class="fa fa-arrow-up"></i>
            </div>
        </div>
        <div id="viewCenter" style="border: 1px solid red;">
            <script language="javascript" for="RealBimOcx" EVENT="OnCurSelModelChanged(strObjName, uObjSubID,   fObjSelX, fObjSelY, fObjSelZ,  fObjBVMinX,fObjBVMinY,fObjBVMinZ,  fObjBVMaxX,fObjBVMaxY,fObjBVMaxZ)" type="text/javascript">

                // if(window.console && console.log){ console.log(uObjSubID); }
                // console.dir(uObjSubID);

                /*var node = [];
                var treeObj = $.fn.zTree.getZTreeObj("ztree");
                var nodes = treeObj.transformToArray(treeObj.getNodes());
                for(var i = 0;i<nodes.length;i++){
                    if(nodes[i].name == 'Y-Ⅵ-969.30-CZ0+024.000-0+054.000'){
                        node.push(nodes[i]);
                        treeObj.checkNode(nodes[i],true);
                    }
                }*/
                // creatSelectedZtree(node,uObjSubID);

                RealBimOcx.ExitSubObjFlicker();

                RealBimOcx.BatchAddSubClrInfoBegin();
                RealBimOcx.AddSubClrPercent(uObjSubID,1,0x80ffa500);
                RealBimOcx.BatchAddSubClrInfoEnd();
                // //设置模型的可见性，0为不可见，1为可见。通过模型id进行关联。
                // RealBimOcx.SetHugeObjSubValidStateBegin();
                // RealBimOcx.SetHugeObjSubValidStateInfo(uObjSubID, 1);
                // RealBimOcx.SetHugeObjSubValidStateEnd();
                // RealBimOcx.SetAllHugeObjSubValidState(0); //全部不显示


                //点击树的时候加载
                //RealBimOcx.SetAllHugeObjSubValidState(0); //全部不显示
                //RealBimOcx.SetHugeObjSubValidStateBegin();
                // for(var i = 0;i<arr.length;i++){        //多层关联可见性
                //RealBimOcx.SetHugeObjSubValidStateInfo(uObjSubID, 1);
                //}
                //RealBimOcx.SetHugeObjSubValidStateEnd();

                //点击表格数据的时候 加载
                // RealBimOcx.FocusCameraToComponent(uObjSubID,3);


                //获取一个构件的可见性状态
                //ULONG uObjSubID:构件ID
                //返回值表示指定构件的有效性:(0表示构件无效，1表示构件有效）
                // ULONG GetAHugeObjSubValidState(ULONG uObjSubID);



                //进入闪烁构件的设置状态
                //FlickerSwitchTimes:闪烁次数
                //FlickerInterval：闪烁时间间隔
                //Alpha0，AlphaAmp0，RGBBlendInfo0，Alpha1，AlphaAmp1，RGBBlendInfo1：两种闪烁状态的透明度，透明度混合系数，以及颜色和颜色混合系数，与AddSubClrInfo()的后三个参数用法相同
                // void SetSubObjFlickerBegin(LONG FlickerSwitchTimes,LONG FlickerInterval, BYTE Alpha0, BYTE AlphaAmp0, ULONG RGBBlendInfo0, BYTE Alpha1, BYTE AlphaAmp1, ULONG RGBBlendInfo1);

                // RealBimOcx.SetSubObjFlickerBegin(20,1000,255,255,0xff87ceeb,255,255,0x8000008b);
                // RealBimOcx.AddFlickerSubObjects(uObjSubID);
                // RealBimOcx.SetSubObjFlickerEnd();


                // 设置透明度和颜色：0为全透明，1为不透明
                //RealBimOcx.BatchAddSubClrInfoBegin();
                //RealBimOcx.AddSubClrPercent(uObjSubID,0.8,0x80ff0000);
                //RealBimOcx.BatchAddSubClrInfoEnd();



                //设置最佳视角
                // RealBimOcx.SetSuitableCam();


            </script>

            <object id="RealBimOcx" classid="CLSID:2CD7E1BE-10B8-4A1C-B908-4FB7D4FD4ABD"  width="100%" height="90%"></object>

            <script language="javascript" for="RealBimOcx" EVENT="OnRealBimOcxInited()" type="text/javascript">
                // RealBimOcx.SwitchBIMSceneSimple("http://192.168.1.58:8008/default.aspx?dir=url_res02&path=","res_fengning_kw_03");

                //设置服务url
                //RealBimOcx.SwitchBIMSceneSimple("F:\\","res_fengning_kw_03");
                RealBimOcx.SwitchBIMSceneSimple("http://192.168.1.2:8008/default.aspx?dir=url_res02&path=","res_fengning_kw");
                RealBimOcx.SetSceVersionInfoExt(100, -1, 0, 2000000000);

                RealBimOcx.CreateAGolFont("CustomFont01","微软雅黑",true,true,14,14,32,1.0,0*64,"");
                RealBimOcx.CreateAGolFont("CustomFont02","微软雅黑",true,true,12,12,8,1.0,0*64,"");
            </script>

            <script language="javascript" for="RealBimOcx" EVENT="WorkCompleteNotification(CompleteEvent,retError)" type="text/javascript">
                if(CompleteEvent == "LoadMainScene" && retError==0 ){
                    RealBimOcx.SetAllHugeObjSubValidState(1);
                    //RealBimOcx.SetSceHugeObjVisible(false);
                }

                RealBimOcx.SetSuitableCam();//放在初始化设置里面就行了

                // var unitId = document.cookie.split(';')[0].split('=')[1];
                //保存关联模型
                // window.saveModel = function (picture_id) {
                //     if(!picture_id){
                //         return false;
                //     }
                //     $.ajax({
                //         url: "{:url('quality/Division/addModelPicture')}",
                //         type: "post",
                //         data: {
                //             id:unitId,
                //             picture_id:picture_id
                //         },
                //         dataType: "json",
                //         success: function (res) {
                //             layer.msg(res.msg);
                //             alert(res.msg);
                //         }
                //     })
                // }
                //加载模型试图
                window.loadModel = function (number) {
                    if(number==''){
                        RealBimOcx.SetAllHugeObjSubValidState(0);
                    }else{
                        RealBimOcx.SetAllHugeObjSubValidState(0);   //设置模型全部不可见
                        RealBimOcx.SetHugeObjSubValidStateBegin();  //启用模型可见
                        RealBimOcx.SetHugeObjSubValidStateInfo(number, 1); //设置单个模型可见
                        RealBimOcx.SetHugeObjSubValidStateEnd();   //停用模型可见
                        RealBimOcx.FocusCameraToComponent(number,1); //3：视角距离
                        //模型视图闪烁
                        RealBimOcx.SetSubObjFlickerBegin(3,500,255,255,0xffffff,255,255,0x80ff0000);
                        RealBimOcx.AddFlickerSubObjects(number);
                        RealBimOcx.SetSubObjFlickerEnd();
                    }
                };
                // loadModel(17)

                //取消模型闪烁
                // window.cancelTwinkle = function () {
                //     RealBimOcx.ExitSubObjFlicker();
                // }
                //FlickerSwitchTimes:闪烁次数
                //FlickerInterval：闪烁时间间隔
                //Alpha0，AlphaAmp0，RGBBlendInfo0，Alpha1，AlphaAmp1，RGBBlendInfo1：两种闪烁状态的透明度，透明度混合系数，以及颜色和颜色混合系数，与AddSubClrInfo()的后三个参数用法相同
                // void SetSubObjFlickerBegin(LONG FlickerSwitchTimes,LONG FlickerInterval, BYTE Alpha0, BYTE AlphaAmp0, ULONG RGBBlendInfo0, BYTE Alpha1, BYTE AlphaAmp1, ULONG RGBBlendInfo1);
            </script>

        </div>
</div>

{include file="../app/public/common_footer.html"}

<script>
    var proWidth = $(".progress").width();
    $(function(){
        var tag = false,ox = 0,left = 0,bgleft = 0;
        $('.progress_btn').mousedown(function(e) {
            ox = e.pageX - left;
            tag = true;
        });
        $(document).mouseup(function() {
            tag = false;
        });
        $('.progress').mousemove(function(e) {
            if (tag) {
                left = e.pageX - ox;
                if (left <= 0) {
                    left = 0;
                }else if (left > proWidth) {
                    left = proWidth;
                }
                $('.progress_btn').css('left', left);
                $('.progress_bar').width(left);
                $('.text').html(parseInt((left/proWidth)*100) + '%');
            }
        });

        $('.progress_bg').click(function(e) {
            if(!tag) {
                bgleft = $('.progress_bg').offset().left;
                left = e.pageX - bgleft;

                if (left <= 0) {
                    left = 0;
                }

                if(left > proWidth) {
                    left = proWidth;
                }

                $('.progress_btn').css('left', left);
                $('.progress_bar').animate({width:left},proWidth);
                $('.text').html(parseInt((left/proWidth)*100) + '%');
            }
        });
    });

    var stime, stimeBackward, stimeForward, times = 1200, backTime = 1200;

    //清除叠加
    function cleanSupTime() {
        window.clearInterval(stime);
        window.clearInterval(stimeBackward);
        window.clearInterval(stimeForward);
    }

    //暂停样式
    function cleanSupElement() {
        cleanSupTime();
        $("#start").css("display","inline-block").siblings("#suspend").css("display","none");
    }

    //开始
    $("#start").click(function () {
        //开始
        $("#start").css("display","none").siblings("#suspend").css("display","inline-block");
        cleanSupTime();
        stime = setInterval(function (){
            $("#fu").css("display","block");
            var oleft = $("#zi")[0].offsetWidth + 96;
            var tipsLeft = Math.round($("#leftTips").offset().left+10);
            var ob = oleft/$("#fu")[0].offsetWidth;
            $("#zi").css("width",oleft+"px");
            $("#leftTips").css("left",tipsLeft+"px");
            if($("#zi")[0].offsetWidth -12 == $("#fu")[0].offsetWidth){
                cleanSupElement();
            }
        },1200)
        if($("#zi")[0].offsetWidth-12 == $("#fu")[0].offsetWidth){
            cleanSupElement();
        }
    });

    //暂停
    $("#suspend").click(function () {
        $("#start").css("display","inline-block").siblings("#suspend").css("display","none");
        cleanSupTime();
    });

    //快退
    $("#backward").click(function () {
        console.log($("#start").css("display"))
        if($("#start").css("display") == 'none'){
            cleanSupTime();
            backTime /= 1.5;
            if(parseInt(backTime) == 237){
                backTime =237
                alert("亲，不能再退这么快了！")
            }
            stime = setInterval(function (){
                $("#fu").css("display","block");
                var oleft = $("#zi")[0].offsetWidth - 96;
                var tipsLeft = Math.round($("#leftTips").offset().left);
                console.log(tipsLeft + "left ")
                var ob = oleft/$("#fu")[0].offsetWidth;
                $("#zi").css("width",oleft+"px");
                tipsLeft -= 181;
                $("#leftTips").css("left",tipsLeft+"px");
                if(oleft == 2){
                    cleanSupElement()
                }
            },backTime)
        }
    });

    //快进
    $("#forward").click(function () {
        console.log($("#start").css("display"))
        if($("#start").css("display") == 'none'){
            cleanSupTime();
            times /= 1.5;
            if(parseInt(times) == 237){
                times =237
                layer.msg("亲，不能再快了！")
            }
            stime = setInterval(function (){
                $("#fu").css("display","block");
                var oleft = $("#zi")[0].offsetWidth + 96;
                var tipsLeft = Math.round($("#leftTips").offset().left+10);
                var ob = oleft/$("#fu")[0].offsetWidth;
                $("#zi").css("width",oleft+"px");
                $("#leftTips").css("left",tipsLeft+"px");
                if($("#zi")[0].offsetWidth -12 == $("#fu")[0].offsetWidth){
                    cleanSupElement();
                }
            },times)

        }

    });

    //关闭页面
    $('#close').click(function () {
        window.close();
    });

    //单元工程段号编号
    var unitId = document.cookie.split(';')[0].split('=')[1];

    //模型主键
    var primaryId;

    //加载构件树
    var modelId = [];
    $.ajax({
        url: "{:url('quality/Division/openModelPicture')}",
        type: "post",
        dataType: "json",
        data:{
            id:window.unitId
        },
        success: function (res) {
            primaryId = res.primaryId;
            //转换节点数据
            var nodes = JSON.parse(res.data)
            setZtree(nodes);
        }
    });

    //构建构件树
    function setZtree(nodes) {
        var setting = {
            check: {
                enable: true
            },
            data: {
                simpleData: {
                    enable: true,
                    idKey: "id",
                    pIdKey: "pId"
                }
            },
            view:{
                selectedMulti: false
            },
            callback:{
                onCheck: zTreeOnCheck,
                onClick: zTreeOnClick
            },
            showLine:true,
            showTitle:true,
            showIcon:true
        };

        zTreeObj = $.fn.zTree.init($("#ztree"), setting, nodes);
        echoRelation();
    }

    //回显已关联节点
    function echoRelation() {
        //初始化后的调用就不用全局获取
        var treeObj = $.fn.zTree.getZTreeObj("ztree");
        // console.log(!treeObj)
        if(!treeObj){
            return false;
        }
        var checkedNode = treeObj.getNodeByParam('picture_id',primaryId);
        treeObj.checkNode(checkedNode,true,false);
        // console.log(checkedNode);
    }
    echoRelation();

    //加载模型视图
    function zTreeOnCheck(event, treeId, treeNode) {
        console.log(treeNode);
        picture_id = treeNode.picture_id;
        //勾选定位模型
        /*if(treeNode.checked){
            loadModel(treeNode.add_id);
        }*/
        // 一对多
        /*var node = [];
        var treeObj = $.fn.zTree.getZTreeObj("ztree");
        var nodes = treeObj.getCheckedNodes(true);
        for(var i = 0;i<nodes.length;i++){
            if(nodes[i].isParent==undefined||nodes[i].isParent==false){
                node.push(nodes[i]);
            }
        }
        creatSelectedZtree(node);*/

        // 一对一
        var node = [];
        var treeObj = $.fn.zTree.getZTreeObj("ztree");
        var checkedNodes = treeObj.getCheckedNodes(true);
        for(var i = 0;i<checkedNodes.length;i++){
            treeObj.checkNode(checkedNodes[i],false,false);
        }
        node.push(treeNode);
        treeObj.checkNode(treeNode,true,false);
        creatSelectedZtree(node);
    }

    //构建已选构件树
    window.creatSelectedZtree = function (node,uObjSubID) {
        var setting = {
            data: {
                simpleData: {
                    enable: true,
                    idKey: "id",
                    pIdKey: "pId"
                }
            },
            view:{
                selectedMulti: false
            },
            callback:{
                onClick: function (event, treeId, treeNode) {
                    zTreeOnClick(event, treeId, treeNode);
                }
            },
            showLine:true,
            showTitle:true,
            showIcon:true
        };
        zTreeObj = $.fn.zTree.init($("#selectZtree"), setting, node);
        var checkedNodes = zTreeObj.getCheckedNodes(true);
        $('#selectCount').text(checkedNodes.length);
    }

    //选中关联节点及加载模型视图
    function zTreeOnClick(event, treeId, treeNode) {
        var number = treeNode.picture_number;
        var treeObj = $.fn.zTree.getZTreeObj("ztree");
        var nodes = treeObj.getNodesByParam("id",treeNode.id);
        treeObj.selectNode(nodes[0],true);
        loadModel(number);
    }

    $('#save').click(function () {
        saveModel(picture_id);
    });

    $('#close').click(function () {
        window.close();
    });

    //搜索模型
    $('#search').click(function () {
        var inputModelName = $('#modelName').val();
        var modelName = $.trim(inputModelName);
        $.ajax({
            url: "",
            type: "post",
            data: {
                modelName:modelName
            },
            dataType: "json",
            success: function (res) {

            }
        })
    });
</script>
</html>